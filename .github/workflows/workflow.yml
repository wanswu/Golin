name: Build and Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - { goos: linux, goarch: amd64, binary: golin_linux_amd64 }
          - { goos: linux, goarch: arm64, binary: golin_linux_arm64 }
          - { goos: windows, goarch: amd64, binary: golin_win_amd64.exe }
          - { goos: windows, goarch: arm64, binary: golin_win_arm64.exe }
          - { goos: darwin, goarch: amd64, binary: golin_darwin_amd64 }
          - { goos: darwin, goarch: arm64, binary: golin_darwin_arm64 }

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Build Binary
        run: |
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
          go build -ldflags "-s -w" -trimpath -o "${{ matrix.binary }}" .

      - name: ğŸ—œï¸ UPX å‹ç¼© (ä»…é™é Mac)
        if: matrix.goos != 'darwin'
        uses: crazy-max/ghaction-upx@v3
        with:
          files: ${{ matrix.binary }}
          args: -9

      - name: ğŸ“¦ ç‹¬ç«‹æ‰“åŒ…
        id: archive
        run: |
          # ç›´æ¥ä½¿ç”¨å½“å‰ Tag åä½œä¸ºå˜é‡
          TAG_NAME="${{ github.ref_name }}"
          PKG_NAME="golin-${TAG_NAME}-${{ matrix.goos }}-${{ matrix.goarch }}"
          
          if [ "${{ matrix.goos }}" == "windows" ]; then
            zip "${PKG_NAME}.zip" "${{ matrix.binary }}"
            echo "ASSET=${PKG_NAME}.zip" >> $GITHUB_OUTPUT
          else
            # tar èƒ½å¤Ÿä¿ç•™æ‰§è¡Œæƒé™ (+x)
            tar -czvf "${PKG_NAME}.tar.gz" "${{ matrix.binary }}"
            echo "ASSET=${PKG_NAME}.tar.gz" >> $GITHUB_OUTPUT
          fi

      - name: æš‚å­˜æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: asset-${{ matrix.goos }}-${{ matrix.goarch }}
          path: ${{ steps.archive.outputs.ASSET }}
          retention-days: 1

  publish:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: å‘å¸ƒè‡³ GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # ä½¿ç”¨ Tag åä½œä¸º Release æ ‡é¢˜
          name: Golin ${{ github.ref_name }}
          files: release-assets/*
          generate_release_notes: true
          body: |
            ### ğŸ› ï¸ å®‰è£…è¯´æ˜
            ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…ï¼Œè§£å‹å³å¯ä½¿ç”¨ã€‚
            
            ---
            *ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒ*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}